#!/bin/bash
set -e

IMAGE_NAME="ralph-loop"
CURRENT_DIR=$(pwd)
AUTH_FILE="$HOME/.local/share/opencode/auth.json"
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PYTHON_SCRIPT="$SCRIPT_DIR/ralph_runner.py"

chmod +x "$PYTHON_SCRIPT"

if [ ! -f "$AUTH_FILE" ]; then
    echo "OpenCode auth not found at $AUTH_FILE"
    echo "Please run 'opencode auth login' on your host machine first."
    exit 1
fi

needs_rebuild() {
    if [[ "$(docker images -q $IMAGE_NAME 2> /dev/null)" == "" ]]; then
        return 0
    fi

    newest_source_mtime=$(stat -c %Y "$SCRIPT_DIR/Dockerfile.ralph" "$SCRIPT_DIR/ralph_runner.py" 2>/dev/null | sort -rn | head -1)

    image_created=$(docker inspect -f '{{.Created}}' "$IMAGE_NAME" 2>/dev/null)
    if [ -z "$image_created" ]; then
        return 0
    fi

    image_epoch=$(date -d "$image_created" +%s 2>/dev/null || echo 0)

    [ "$newest_source_mtime" -gt "$image_epoch" ]
}

if needs_rebuild; then
    echo "Source files newer than image. Rebuilding..."
    docker build -t $IMAGE_NAME -f "$SCRIPT_DIR/Dockerfile.ralph" "$SCRIPT_DIR"
else
    echo "Image up to date, skipping rebuild."
fi

if [ ! -f "$CURRENT_DIR/ideas.txt" ]; then
    echo "No ideas.txt found in current directory."
    echo "Create one to tell Ralph what to build."
    exit 1
fi

echo "Launching Ralph..."
docker run -it --rm \
    --network bridge \
    -v "$CURRENT_DIR:/workspace" \
    -v "$AUTH_FILE:/home/ralph/.local/share/opencode/auth.json:ro" \
    -v "$SCRIPT_DIR/ralph_runner.py:/usr/local/bin/ralph" \
    $IMAGE_NAME
