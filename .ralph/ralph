#!/bin/bash
set -e

IMAGE_NAME="ralph-loop"
CURRENT_DIR=$(pwd)
AUTH_FILE="$HOME/.local/share/opencode/auth.json"
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PYTHON_SCRIPT="$SCRIPT_DIR/ralph_runner.py"

chmod +x "$PYTHON_SCRIPT"

if [ ! -f "$AUTH_FILE" ]; then
    echo "OpenCode auth not found at $AUTH_FILE"
    echo "Please run 'opencode auth login' on your host machine first."
    exit 1
fi

if [[ "$(docker images -q $IMAGE_NAME 2> /dev/null)" == "" ]]; then
    echo "Building Ralph Image..."
    docker build -t $IMAGE_NAME -f "$SCRIPT_DIR/Dockerfile.ralph" "$SCRIPT_DIR"
fi

if [ ! -f "$CURRENT_DIR/ideas.txt" ]; then
    echo "No ideas.txt found in current directory."
    echo "Create one to tell Ralph what to build."
    exit 1
fi

echo "Launching Ralph..."
docker run -it --rm \
    --network host \
    -v "$CURRENT_DIR:/workspace" \
    -v "$AUTH_FILE:/root/.local/share/opencode/auth.json:ro" \
    -v "$SCRIPT_DIR/ralph_runner.py:/usr/local/bin/ralph" \
    $IMAGE_NAME
